<ul id="navstrip" class="clearfix">
	<li class="begin"><a href="{U_INDEX}"><span>{L_INDEX}</span></a></li>
	{NAV_CAT_DESC}
	<li>{L_VIEW_PROFILE}</li>
	<li>{USERNAME}</li>
</ul>

<script type="text/javascript">
//<![CDATA[
  const membersList = [{
  	id: {USER_ID},
  	name: `{USERNAME}`,
  	avatar: `{AVATAR_IMG}`,
        status: `<!-- BEGIN switch_show_status --> {USER_ONLINE} <!-- END switch_show_status -->`,
  	rank: `{POSTER_RANK}`,
  	last_visit: `{LAST_VISIT_TIME}`,
  	awards: `<!-- BEGIN switch_awards --><dt class="subtitle">{switch_awards.L_AWARDS} : </dt><dd class="awards_block_simple">{switch_awards.AWARDS_LIST}</dd><!-- END switch_awards -->`,
  	other: `<!-- BEGIN profile_field --><dl id="field_id{profile_field.ID}"><dt>{profile_field.LABEL}</dt>
                  <dd><div>{profile_field.CONTENT}</div><!-- BEGIN profil_type_user_posts --> ({POST_PERCENT_STATS} / {POST_DAY_STATS})<!-- END profil_type_user_posts --></dd>
                </dl><!-- END profile_field -->`,
  	comments: `<!-- BEGIN switch_admin_user_comment_active --> {ADMIN_USER_COMMENT} <!-- END switch_admin_user_comment_active -->`
  }];
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
function stripHtml(htmlString) {
    if (typeof htmlString !== 'string' || !htmlString) return '';
    const doc = new DOMParser().parseFromString(htmlString, 'text/html');
    return doc.documentElement.textContent.trim();
}

function extractFieldValues(htmlString) {
    if (!htmlString || typeof htmlString !== 'string') return [];
    const parser = new DOMParser();
    const doc = parser.parseFromString(htmlString, 'text/html');
    const editableFields = doc.querySelectorAll('.field_uneditable');
    const values = [];
    editableFields.forEach(fieldDiv => {
        const cleanText = fieldDiv.textContent.trim();
  
        if (cleanText && cleanText !== '-' && cleanText !== '&nbsp;-') {
            values.push(cleanText);
        }
    });
    return values;
}
  
function parseAndCleanMembers(rawList) {
    if (!rawList || rawList.length === 0) return [];

    return rawList.map(member => {
        const cleanName = stripHtml(member.name);
        const cleanRank = stripHtml(member.rank);
        const cleanPostsText = stripHtml(member.posts);
        const otherValues = extractFieldValues(member.other);

        const customFields = {
            gender: otherValues.find(val => val.includes('masculin') || val.includes('feminin')) || '',
            birth_info: otherValues.find(val => val.includes('Luna') || val.includes('An')) || '',
            bio: otherValues.find(val => val.length > 50) || ''
        };

        return {
            id: member.id,
            name: cleanName,
            rank: cleanRank,
            avatar: stripHtml(member.avatar),
            posts_text: cleanPostsText,
            last_visit: member.last_visit.trim(),
            status: member.status.trim(),
            gender: customFields.gender,
            bio_description: customFields.bio
        };
    });
}
  
if (typeof membersList !== 'undefined') {
    const finalCleanList = parseAndCleanMembers(membersList);
    console.log("Lista finalÄƒ gata de IndexedDB:", finalCleanList);
}
//]]>
</script>
<div class="borderwrap profile-view">
	<div class="maintitle">
		<h1>{L_VIEWING_PROFILE}</h1>
	</div>

	<div class="box-content row1 clearfix">
		<h4 class="subtitle">{L_PERSONAL_INFO}</h4>
		<div class="personal-info clearfix">
			<div class="avatar">
				<span class="real_avatar">{AVATAR_IMG}</span>
				<!-- BEGIN switch_follow_member -->
				<div class="block-follow">
					<button onclick="doFollowAction(this);" data-id="{CUR_USER_ID}" class="followBtn {C_CLASS} button1">
                        {CUR_FOLLOW_TEXT}
					</button>
				</div>
				<!-- END switch_follow_member -->
				<!-- BEGIN switch_allow_friendsfoes -->
				{FRIENDSFOES}
				<br />
				<!-- END switch_allow_friendsfoes -->
				<!-- BEGIN switch_awards -->
				<dl class="left-box details" style="margin-top: 10px">
					<dt class="subtitle">{switch_awards.L_AWARDS} : </dt><dd class="awards_block_simple">{switch_awards.AWARDS_LIST}</dd>
				</dl>
				<br>
				<!-- END switch_awards -->
                {L_PM}: {PM_IMG}
				<br />
				{L_TOPICS_POSTS}
				<!-- BEGIN switch_auth_user -->
				<br />
				<br />
				<dl>
					<dt>{L_ADMINISTRATE_USER}:</dt><dd><strong>{ADMINISTRATE_USER}{BAN_USER}</strong></dd>
				</dl>
				<!-- END switch_auth_user -->

			</div>

			<fieldset class="profile-view-list">
				<dl>
					<dt>
						{USERNAME}
					</dt>
					<dd>&nbsp;</dd>
				</dl>
				<div class="separator">&nbsp;</div>
				<!-- BEGIN switch_show_status -->
				<dl>
					<dt>
						{L_STATUT}:
					</dt>
					<dd>
						{USER_ONLINE}
					</dd>
				</dl>
				<div class="separator">&nbsp;</div>
				<!-- END switch_show_status -->
				<dl>
					<dt>
						{L_RANK}:
					</dt>
					<dd>
						{POSTER_RANK}
					</dd>
				</dl>
				<!-- BEGIN switch_groups_list -->
				<div class="separator">&nbsp;</div>
				<dl id="groups-details">
					<dt>{switch_groups_list.L_GROUPS}:</dt>
					<dd>
					<!-- BEGIN group_details -->
					<div id="{switch_groups_list.group_details.GROUP_ID}-name"><a href="{switch_groups_list.group_details.U_GROUP}" >{switch_groups_list.group_details.L_GROUP_NAME}</a></div>
					<!-- END group_details -->
					</dd>
				</dl>
				<!-- END switch_groups_list -->
				<div class="separator">&nbsp;</div>
					<!-- BEGIN profile_field -->
					<dl id="field_id{profile_field.ID}">
						<dt>
							{profile_field.LABEL}
						</dt>
						<dd>
							<div>{profile_field.CONTENT}</div><!-- BEGIN profil_type_user_posts --> ({POST_PERCENT_STATS} / {POST_DAY_STATS})<!-- END profil_type_user_posts -->
						</dd>
					</dl>
					<div class="separator">&nbsp;</div>
					<!-- END profile_field -->
			</fieldset>
		</div>

			<!-- BEGIN switch_admin_user_comment_active -->
			<h4 class="subtitle">{L_COMMENTS}</h4>
			<form action="{S_PROFILE_ACTION}" method="post" name="post" class="ipbform2">
			<dl>
				<dt><label>{L_MODS_AND_ADMINS}</label></dt>
				<dd>
					<textarea name="admin_user_comment_text" rows="8" cols="30">{ADMIN_USER_COMMENT}</textarea>
					<label>&nbsp;</label>
					<input type="hidden" value="update_admin_user_comment" name="mode" />
					<input type="hidden" value="{USER_ID}" name="userid" />
					<input type="submit" name="user_comment_maj" value="{L_UPDATE}" class="button" />
				</dd>
			</dl>
			</form>
			<!-- END switch_admin_user_comment_active -->

		<div class="clearfix"></div>

		<h4 class="subtitle">{L_STATS}</h4>
		<fieldset class="profile-view-list">
			<dl>
				<dt>
					{L_LAST_VISITED}:
				</dt>
				<dd>
					{LAST_VISIT_TIME}
				</dd>
			</dl>
				<!-- BEGIN switch_dhow_mp -->
				<div class="separator">&nbsp;</div>
				<dl>
					<dt>
						{L_PRIVATE_MSG}:
					</dt>
					<dd>
						{PRIVATE_MSG}
					</dd>
				</dl>
				<!-- END switch_dhow_mp -->
		</fieldset>

		<h4 class="subtitle">{L_CONTACT} {USERNAME}</h4>
		<form action="{S_PROFILE_ACTION}" method="post" name="post">
			<fieldset class="profile-view-list">
				<!-- BEGIN contact_field -->
				<dl id="field_id{contact_field.ID}">
					<dt>
						{contact_field.LABEL}
					</dt>
					<dd>
						{contact_field.CONTENT}
					</dd>
				</dl>
				<!-- END contact_field -->
			</fieldset>
		</form>
	</div>

	<!-- BEGIN switch_rpg -->
	<h4 class="subtitle">{L_VIEWING_RPG}</h4>

	<div class="ipbform2 clearfix">
		<dl>
			<dt>{RPG_IMAGE}</dt>
			<dd>&nbsp;</dd>
		</dl>

		<!-- BEGIN rpg_fields_left -->
		<dl>
			<dt>{switch_rpg.rpg_fields_left.F_NAME} :</dt>
			<dd>{switch_rpg.rpg_fields_left.F_VALUE_NEW}</dd>
		</dl>
		<!-- END rpg_fields_left -->

		<!-- BEGIN rpg_fields -->
		<dl>
			<dt>{switch_rpg.rpg_fields.F_NAME} :</dt>
			<dd>{switch_rpg.rpg_fields.F_VALUE_NEW}</dd>
		</dl>
	<!-- END rpg_fields -->
		<dl class="clearfix">
			<dt>&nbsp;</dt>
			<dd>
				{U_ADMIN_RPG}
			</dd>
		</dl>
	</div>
	<!-- END switch_rpg -->
</div>
<script src="{JQUERY_ROOT}json/jquery.json-1.3.min.js" type="text/javascript"></script>
<script type="text/javascript">
//<![CDATA[
	$(document).ready(function(){
		$('[id^=field_id]').each(function(){
			if ( $(this).find('.field_editable').is('span, div') )
			{
				$(this).hover(function()
				{
					if( $(this).find('.field_editable.invisible').is('span, div') )
					{
						$(this).find('.field_editable').prev().addClass('ajax-profil_hover').parent().addClass('ajax-profil_parent').append('<div class="ajax-profil_edit"><img src="{AJAX_EDIT_IMG}" /></div>');
						$(this).find('.ajax-profil_edit').attr({
								alt: "{L_FIELD_EDIT_VALUE}",
								title: "{L_FIELD_EDIT_VALUE}"
							}).click(function(){
							$(this).prev().prev().removeClass('ajax-profil_hover').addClass('invisible').next().removeClass('invisible').append('<img src="{AJAX_VALID_IMG}" class="ajax-profil_valid" />').find('input,select');
							$(this).prev().find('.ajax-profil_valid').attr({
								alt: "{L_VALIDATE}",
								title: "{L_VALIDATE}"
							}).click(function(){
								var content = new Array();
								$(this).parent().find('[name]').each(function(){
									var type_special = $(this).is('input[type=radio],input[type=checkbox]');
									if ( (type_special && $(this).is(':checked')) || !type_special )
									{
										content.push(new Array($(this).attr('name'), $(this).attr('value')));
									}
								});
								var id_name = $(this).parents('[id^=field_id]').attr('id');
								var id = id_name.substring(8, id_name.length);
								$.post(
									"{U_AJAX_PROFILE}",
									{id:id,user:"{CUR_USER_ID}",active:"{CUR_USER_ACTIVE}",content:$.toJSON(content),tid:"{TID}"},
									function(data){
										$.each(data, function (i, item) {
											if (item.startsWith('error : ')){
												let present_err=document.getElementById('field_id' + i + "_err");
												if(!present_err){
													let err = document.createElement('div');
													err.id = 'field_id' + i + "_err";
													err.classList.add("form-error");
													err.textContent = item.substring(8);
													document.getElementById('field_id' + i).querySelector('.field_editable input').after(err);
												}else{
													present_err.innerText=item.substring(8);
												}
											}else {
												let err=document.getElementById('field_id' + i + "_err");
												if(err){
													err.remove();
												}
												$('[id=field_id' + i + ']').find('.field_uneditable').html(item).end().find('.ajax-profil_valid').remove().end().find('.field_editable').addClass('invisible').end().find('.field_uneditable').removeClass('invisible');
											}
										});
									},
									"json"
								);
							});
							$(this).remove();
						});
					}
				},function()
				{
					if( $(this).find('.field_editable.invisible').is('span, div') )
					{
						$(this).find('.field_editable').prev().removeClass('ajax-profil_hover');
						$(this).find('.ajax-profil_edit').remove();
					}
				});
			}
		});
	});
//]]>
</script>
